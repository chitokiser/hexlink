<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HEX Product Index</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body { background:#0b1220; color:#e5e7eb; }

    .cardx {
      background:#0f172a;
      border:1px solid #243044;
      border-radius:16px;
      overflow:hidden;
      height:100%;
      display:flex;
      flex-direction:column;
      box-shadow:0 12px 30px rgba(0,0,0,0.35);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }
    .cardx:hover { transform: translateY(-4px); box-shadow:0 18px 40px rgba(0,0,0,0.55); }

    .imgwrap { position:relative; padding-top:66%; background:#0b1220; }
    .imgwrap img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }

    .body { padding:14px 16px 10px; flex:1; display:flex; flex-direction:column; gap:6px; }
    .title { font-size:1rem; margin:0; color:#f8fafc; }
    .desc { font-size:0.9rem; margin:0; color:#cbd5e1; }

    .btnwrap {
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:8px;
      padding:12px 12px 14px;
      border-top:1px solid #243044;
      background:rgba(2,6,23,0.6);
    }
    .btn-mini { border-radius:999px; font-size:0.85rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .muted { color:#cbd5e1; font-size:0.9rem; }
    .disabled-link { opacity:0.45; pointer-events:none; }
  </style>
</head>

<body>
  <nav class="navbar navbar-dark bg-dark border-bottom border-secondary">
    <div class="container">
      <span class="navbar-brand mb-0">HEX Product Index</span>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-info" href="admin.html">admin</a>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <div class="mb-3">
      <div class="h4 mb-1">상품 목록</div>
      <div class="muted" id="status">불러오는 중...</div>
    </div>

    <div class="row g-3" id="grid"></div>

    <div class="text-center muted py-5 d-none" id="empty">
      등록된 상품이 없습니다.
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
  <script src="src/firebase.js"></script>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const setStatus = (msg) => $("status").textContent = msg || "";

      function safe(v) { return (v == null) ? "" : String(v); }
      function toInt(v) {
        const n = Number(String(v).trim());
        return Number.isFinite(n) ? Math.floor(n) : null;
      }

      function linkButton(label, url, btnClass) {
        const a = document.createElement("a");
        a.className = `btn btn-sm ${btnClass} btn-mini`;
        a.textContent = label;

        if (url && url.trim() !== "") {
          a.href = url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
        } else {
          a.href = "javascript:void(0)";
          a.classList.add("disabled-link");
        }
        return a;
      }

      function isValidItem(item) {
        if (!item || typeof item !== "object") return false;
        const no = toInt(item.productNo);
        const title = safe(item.title).trim();
        const detailUrl = safe(item.detailUrl).trim();

        // ✅ 필수 3종
        if (no == null) return false;
        if (!title) return false;
        if (!detailUrl) return false;

        return true;
      }

      function render(itemsObj) {
        const grid = $("grid");
        const empty = $("empty");

        const entriesRaw = itemsObj ? Object.entries(itemsObj) : [];

        // ✅ 유효한 것만 필터
        const entries = entriesRaw.filter(([k, item]) => isValidItem(item));

        // productNo 기준 오름차순
        entries.sort((a, b) => toInt(a[1].productNo) - toInt(b[1].productNo));

        grid.innerHTML = "";

        if (entries.length === 0) {
          empty.classList.remove("d-none");
          setStatus("");
          return;
        }

        empty.classList.add("d-none");
        setStatus("");

        for (const [key, item] of entries) {
          const no = toInt(item.productNo);

          const col = document.createElement("div");
          col.className = "col-12 col-sm-6 col-lg-4";

          const card = document.createElement("div");
          card.className = "cardx";

          const imgwrap = document.createElement("div");
          imgwrap.className = "imgwrap";

          const img = document.createElement("img");
          img.src = `images/product/${no}.png`;
          img.alt = safe(item.title) || "product";
          imgwrap.appendChild(img);

          const body = document.createElement("div");
          body.className = "body";

          const title = document.createElement("h3");
          title.className = "title";
          title.textContent = `[${no}] ${safe(item.title)}`;

          const desc = document.createElement("p");
          desc.className = "desc";
          desc.textContent = safe(item.shortDesc);

          body.appendChild(title);
          body.appendChild(desc);

          const btnwrap = document.createElement("div");
          btnwrap.className = "btnwrap";

          btnwrap.appendChild(linkButton("상세보기", safe(item.detailUrl), "btn-primary"));
          btnwrap.appendChild(linkButton("판매자몰", safe(item.sellerMall), "btn-success"));
          btnwrap.appendChild(linkButton("쿠팡", safe(item.coupangLink), "btn-warning"));
          btnwrap.appendChild(linkButton("쇼핑", safe(item.shoppingLink), "btn-warning"));
          btnwrap.appendChild(linkButton("회원전용", safe(item.memberLink), "btn-outline-light"));

          card.appendChild(imgwrap);
          card.appendChild(body);
          card.appendChild(btnwrap);

          col.appendChild(card);
          grid.appendChild(col);
        }
      }

      if (!window.firebase || !firebase.apps || firebase.apps.length === 0) {
        setStatus("Firebase 초기화 실패");
        return;
      }

      let db;
      try { db = window.db || firebase.database(); } catch (e) { console.error(e); }

      if (!db) {
        setStatus("DB 연결 실패");
        return;
      }

      setStatus("불러오는 중...");
      db.ref("items").on("value", snap => {
        render(snap.val());
      }, err => {
        console.error(err);
        setStatus("DB 로드 실패");
      });
    })();
  </script>
</body>
</html>
