<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HEX Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#0b1220; color:#e5e7eb; }
    .card { background:#0f172a; border:1px solid #243044; border-radius:16px; }
    .muted { color:#cbd5e1; font-size:0.9rem; }
    .thumb { width:180px; height:120px; object-fit:cover; border-radius:12px; border:1px solid #243044; background:#0b1220; }

    .form-label { color:#e5e7eb; }
    .form-control, textarea {
      background:#0b1220; color:#f8fafc; border:1px solid #334155;
    }
    .form-control::placeholder, textarea::placeholder { color:#94a3b8; }
    .form-control:focus, textarea:focus { box-shadow:none; border-color:#38bdf8; }

    .table { color:#e5e7eb; }
    .table thead th { color:#f8fafc; border-bottom-color:#334155; }
    .table tbody td { border-top-color:#243044; }

    .btn-mini { border-radius:999px; font-size:0.85rem; }
    .badge-mini {
      font-size:0.75rem;
      background:#111827;
      border:1px solid #243044;
      border-radius:999px;
      padding:3px 8px;
      display:inline-block;
    }
  </style>
</head>

<body>
<nav class="navbar navbar-dark bg-dark border-bottom border-secondary">
  <div class="container">
    <span class="navbar-brand">HEX Admin</span>
    <a href="index.html" class="btn btn-sm btn-outline-info">index</a>
  </div>
</nav>

<main class="container my-4">
  <div class="row g-4">

    <!-- 입력 영역 -->
    <div class="col-12 col-lg-5">
      <div class="card p-4">
        <div class="h5 mb-2">상품 등록 / 수정</div>
        <div class="muted mb-3">
          제품번호 직접 입력 → 이미지 자동 매칭<br>
          Shopify URL은 제목/짧은설명/상세URL만 채웁니다
        </div>

        <input type="hidden" id="itemKey">

        <div class="mb-3">
          <label class="form-label">Shopify 상품 URL</label>
          <div class="input-group">
            <input id="shopifyUrl" class="form-control"
                   placeholder="https://heritagex-2.myshopify.com/products/...">
            <button id="fetchBtn" class="btn btn-outline-info">가져오기</button>
          </div>
        </div>

        <div class="mb-2">
          <label class="form-label">제품번호</label>
          <input id="productNo" class="form-control" inputmode="numeric" placeholder="0, 1, 2..." />
          <div class="muted mt-1">같은 제품번호는 1개만 존재</div>
        </div>

        <div class="mb-2">
          <label class="form-label">상품명</label>
          <input id="title" class="form-control" placeholder="상품명" />
        </div>

        <div class="mb-2">
          <label class="form-label">짧은 설명</label>
          <textarea id="shortDesc" rows="2" class="form-control"
                    placeholder="카드에 표시될 짧은 문장"></textarea>
        </div>

        <div class="mb-2">
          <label class="form-label">상세페이지 URL</label>
          <input id="detailUrl" class="form-control" placeholder="https://..." />
          <div class="muted mt-1">※ Shopify 버튼은 이 URL로 연결됩니다</div>
        </div>

        <hr class="border-secondary my-3">

        <div class="row g-2">
          <div class="col-12 col-md-6">
            <label class="form-label">쿠팡 링크</label>
            <input id="coupangLink" class="form-control" placeholder="https://..." />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">쇼핑 링크(쇼피 등)</label>
            <input id="shoppingLink" class="form-control" placeholder="https://..." />
          </div>
        </div>

        <div class="mt-2">
          <label class="form-label">회원전용몰 링크</label>
          <input id="memberLink" class="form-control" placeholder="https://..." />
        </div>

        <div class="mt-3 d-flex align-items-center gap-3">
          <img id="preview" class="thumb" src="images/product/0.png" alt="preview">
          <div class="muted">
            <div>미리보기</div>
            <div class="badge-mini" id="imgHint">images/product/0.png</div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button id="newBtn" class="btn btn-outline-light w-50">새로 입력</button>
          <button id="saveBtn" class="btn btn-primary w-50">저장</button>
        </div>

        <div id="status" class="muted mt-2"></div>
      </div>
    </div>

    <!-- 목록 영역 -->
    <div class="col-12 col-lg-7">
      <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="h6 mb-0">등록된 상품</div>
          <div class="muted">미등록 항목은 숨김</div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width:10%;">No</th>
                <th style="width:46%;">상품명</th>
                <th style="width:28%;">이미지</th>
                <th style="width:16%;"></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="empty" class="muted text-center py-4 d-none">
          표시할 상품이 없습니다
        </div>
      </div>
    </div>

  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
<script src="src/firebase.js"></script>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const db = window.db || firebase.database();
  const ref = db.ref("items");

  function safe(v){ return (v == null) ? "" : String(v); }
  function trim(v){ return safe(v).trim(); }
  function toInt(v){
    const n = Number(trim(v));
    return Number.isFinite(n) ? Math.floor(n) : null;
  }
  function setStatus(msg){ $("status").textContent = msg || ""; }

  function setPreviewByNo(no){
    const n = toInt(no);
    if (n == null){
      $("preview").src = "images/product/0.png";
      $("imgHint").textContent = "제품번호 오류";
      return;
    }
    const path = `images/product/${n}.png`;
    $("preview").src = path;
    $("imgHint").textContent = path;
  }

  function isValidItem(item){
    if (!item) return false;
    if (toInt(item.productNo) == null) return false;
    if (!trim(item.title)) return false;
    if (!trim(item.detailUrl)) return false;
    return true;
  }

  function clearForm(){
    $("itemKey").value = "";
    $("shopifyUrl").value = "";
    $("productNo").value = "";
    $("title").value = "";
    $("shortDesc").value = "";
    $("detailUrl").value = "";
    $("coupangLink").value = "";
    $("shoppingLink").value = "";
    $("memberLink").value = "";
    setPreviewByNo(0);
    setStatus("");
  }

  function fillForm(key, item){
    $("itemKey").value = key;
    $("productNo").value = safe(item.productNo);
    $("title").value = safe(item.title);
    $("shortDesc").value = safe(item.shortDesc);
    $("detailUrl").value = safe(item.detailUrl);
    $("coupangLink").value = safe(item.coupangLink);
    $("shoppingLink").value = safe(item.shoppingLink);
    $("memberLink").value = safe(item.memberLink);
    setPreviewByNo(item.productNo);
    setStatus("수정 후 저장하세요");
    window.scrollTo({ top:0, behavior:"smooth" });
  }

  async function fetchShopifyMeta(){
    const url = trim($("shopifyUrl").value);
    if (!url) return alert("Shopify URL 입력");

    try {
      setStatus("가져오는 중...");
      const html = await fetch("https://r.jina.ai/" + url).then(r => r.text());
      const title = (html.match(/property="og:title" content="([^"]+)"/)||[])[1]||"";
      const desc  = (html.match(/property="og:description" content="([^"]+)"/)||[])[1]||"";
      if (title) $("title").value = title;
      if (desc) $("shortDesc").value = desc;
      $("detailUrl").value = url;
      setStatus("가져오기 완료");
    } catch(e){
      console.error(e);
      setStatus("가져오기 실패");
    }
  }

  async function saveItem(){
    const productNo = toInt($("productNo").value);
    if (productNo == null) return alert("제품번호 숫자 입력");
    if (!trim($("title").value)) return alert("상품명 입력");
    if (!trim($("detailUrl").value)) return alert("상세 URL 입력");

    const detailUrl = trim($("detailUrl").value);

    const snap = await ref.orderByChild("productNo").equalTo(productNo).once("value");
    const exist = snap.val();
    const existKey = exist ? Object.keys(exist)[0] : null;

    const currentKey = trim($("itemKey").value) || null;
    if (existKey && currentKey && existKey !== currentKey) {
      alert("같은 제품번호가 존재합니다. 해당 항목을 불러옵니다.");
      fillForm(existKey, exist[existKey]);
      return;
    }

    const key = currentKey || existKey || ref.push().key;

    const data = {
      productNo,
      title: trim($("title").value),
      shortDesc: trim($("shortDesc").value),
      detailUrl,
      sellerMall: detailUrl,   // ✅ Shopify 버튼 = 상세 URL
      coupangLink: trim($("coupangLink").value),
      shoppingLink: trim($("shoppingLink").value),
      memberLink: trim($("memberLink").value),
      updatedAt: Date.now()
    };

    setStatus("저장 중...");
    await ref.child(key).set(data);
    $("itemKey").value = key;
    setStatus("저장 완료");
    loadItems();
  }

  function loadItems(){
    ref.once("value", snap => {
      const data = snap.val() || {};
      const entries = Object.entries(data).filter(([k,v]) => isValidItem(v));
      entries.sort((a,b)=>toInt(a[1].productNo)-toInt(b[1].productNo));

      const tbody = $("tbody");
      const empty = $("empty");
      tbody.innerHTML = "";

      if (entries.length === 0){
        empty.classList.remove("d-none");
        return;
      }
      empty.classList.add("d-none");

      for (const [key,item] of entries){
        const no = toInt(item.productNo);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${no}</td>
          <td>
            <div>${safe(item.title)}</div>
            <div class="muted">${safe(item.shortDesc)}</div>
          </td>
          <td><img src="images/product/${no}.png" class="thumb"></td>
          <td><button class="btn btn-sm btn-outline-info btn-mini">수정</button></td>
        `;
        tr.querySelector("button").onclick = ()=>fillForm(key,item);
        tbody.appendChild(tr);
      }
    });
  }

  $("fetchBtn").onclick = fetchShopifyMeta;
  $("saveBtn").onclick = saveItem;
  $("newBtn").onclick = clearForm;
  $("productNo").oninput = e => setPreviewByNo(e.target.value);

  clearForm();
  loadItems();
})();
</script>
</body>
</html>
